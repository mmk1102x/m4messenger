<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M4messenger</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/webrtc.js"></script>
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg: #1a1a1a;
            --sidebar: #111;
            --text: #eee;
            --accent: #00ff88;
            --accent-text: #000;
            --dim: #666;
            --msg-bg: #222;
            --msg-me: #004422;
            --radius: 0px; /* Square Default */
            --font: 'Courier New', monospace;
        }

        /* --- THEMES --- */
        [data-theme="light"] { --bg: #fff; --sidebar: #eee; --text: #111; --accent: #000; --accent-text: #fff; --msg-bg: #f0f0f0; --msg-me: #ddd; }
        [data-theme="blue"] { --bg: #0d1b2a; --sidebar: #050a10; --text: #e0e1dd; --accent: #415a77; --accent-text: #fff; --msg-bg: #1b263b; --msg-me: #0d1b2a; }
        [data-theme="purple"] { --bg: #1a0b2e; --sidebar: #110524; --text: #e0d1ff; --accent: #762bd9; --accent-text: #fff; --msg-bg: #2d1b4e; --msg-me: #3a1c6e; }
        [data-theme="crimson"] { --bg: #2a0a0a; --sidebar: #1a0000; --text: #ffcccc; --accent: #dc143c; --accent-text: #fff; --msg-bg: #3b0000; --msg-me: #5c0000; }
        [data-theme="emerald"] { --bg: #052b18; --sidebar: #001a0d; --text: #ccffdd; --accent: #00cc66; --accent-text: #000; --msg-bg: #00331a; --msg-me: #004d26; }
        [data-theme="midnight"] { --bg: #000000; --sidebar: #0a0a0a; --text: #cccccc; --accent: #333333; --accent-text: #fff; --msg-bg: #111111; --msg-me: #222222; }
        [data-theme="coffee"] { --bg: #2b2118; --sidebar: #1f1610; --text: #dcc8b8; --accent: #a67c52; --accent-text: #000; --msg-bg: #3e2f24; --msg-me: #543d2e; }
        [data-theme="solarized"] { --bg: #fdf6e3; --sidebar: #eee8d5; --text: #657b83; --accent: #b58900; --accent-text: #fff; --msg-bg: #fff; --msg-me: #eee; }
        [data-theme="amber"] { --bg: #111; --sidebar: #000; --text: #ffb000; --accent: #ffb000; --accent-text: #000; --msg-bg: #222; --msg-me: #332200; }

        /* --- GLOBAL RESET & A11Y --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; border-radius: var(--radius); }
        body { font-family: var(--font); background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; transition: 0.3s; }
        
        /* High Contrast Focus for Keyboard Users */
        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: -2px;
            z-index: 10;
        }

        button { cursor: pointer; border: none; background: var(--accent); color: var(--accent-text); padding: 10px; font-weight: bold; text-transform: uppercase; }
        input, textarea { background: var(--msg-bg); border: 1px solid var(--dim); color: var(--text); padding: 10px; width: 100%; font-family: inherit; }
        
        /* --- SNOW CANVAS --- */
        #snow-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: none; }

        /* --- LAYOUT --- */
        #sidebar { width: 300px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid var(--dim); z-index: 100; transition: transform 0.3s; }
        #main { flex: 1; display: flex; flex-direction: column; position: relative; }

        /* --- SIDEBAR COMPONENTS --- */
        .brand { padding: 15px; background: var(--accent); color: var(--accent-text); font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .lists { flex: 1; overflow-y: auto; padding: 10px; }
        .section-title { font-size: 0.8em; color: var(--dim); margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; }
        .list-item { padding: 8px; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; justify-content: space-between; }
        .list-item:hover, .list-item:focus { background: var(--msg-bg); border-color: var(--accent); }
        .list-item.active { background: var(--accent); color: var(--accent-text); }
        
        /* Command Box */
        .cmd-area { padding: 10px; border-top: 1px solid var(--dim); background: var(--sidebar); }
        #cmd-feedback { font-size: 0.8em; color: var(--accent); min-height: 1.2em; margin-bottom: 5px; }

        /* --- CHAT AREA --- */
        #chat-header { padding: 15px; border-bottom: 1px solid var(--dim); background: var(--bg); display: flex; justify-content: space-between; align-items: center; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; background: var(--msg-bg); border: 1px solid var(--dim); align-self: flex-start; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: var(--msg-me); border-color: var(--accent); }
        .msg-meta { font-size: 0.7em; color: var(--dim); margin-bottom: 2px; display: block; }
        
        #input-area { padding: 20px; border-top: 1px solid var(--dim); display: flex; gap: 10px; background: var(--bg); }
        #msg-input { flex: 1; resize: none; height: 50px; }
        #send-btn { width: 80px; }

        /* --- MODALS --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: var(--bg); border: 2px solid var(--accent); padding: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal h2 { margin-bottom: 15px; color: var(--accent); border-bottom: 1px solid var(--dim); padding-bottom: 5px; }
        .modal-row { display: flex; justify-content: space-between; margin: 5px 0; padding: 5px 0; border-bottom: 1px solid #333; }
        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .theme-btn { padding: 15px; border: 1px solid var(--dim); text-align: center; cursor: pointer; }
        .theme-btn:focus { border-color: var(--accent); }

        /* --- MOBILE DRAWER --- */
        @media (max-width: 768px) {
            #sidebar { position: fixed; height: 100%; transform: translateX(-100%); width: 80%; box-shadow: 2px 0 10px #000; }
            #sidebar.open { transform: translateX(0); }
            #menu-toggle { display: block !important; }
        }
        #menu-toggle { display: none; background: transparent; color: var(--text); font-size: 1.5em; padding: 0; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Global Effects -->
    <canvas id="snow-canvas"></canvas>

    <!-- Modals -->
    <div id="modal-help" class="modal">
        <div class="modal-content">
            <h2>Commands</h2>
            <div class="modal-row"><span>clean</span><span>Factory Reset</span></div>
            <div class="modal-row"><span>soft</span><span>Toggle Radius</span></div>
            <div class="modal-row"><span>snow</span><span>Toggle Snow</span></div>
            <div class="modal-row"><span>theme</span><span>Theme Picker</span></div>
            <div class="modal-row"><span>stats</span><span>Network Stats</span></div>
            <div class="modal-row"><span>nick @u Name</span><span>Set Alias</span></div>
            <div class="modal-row"><span>lang</span><span>Switch Lang</span></div>
            <br>
            <h2>Keyboard Shortcuts</h2>
            <div class="modal-row"><span>Alt + C</span><span>Focus Chat</span></div>
            <div class="modal-row"><span>Alt + M</span><span>Command Line</span></div>
            <div class="modal-row"><span>Alt + R</span><span>Room List</span></div>
            <div class="modal-row"><span>Esc</span><span>Close Modals</span></div>
            <button onclick="closeModals()" style="width:100%; margin-top:10px;">Close (Esc)</button>
        </div>
    </div>

    <div id="modal-theme" class="modal">
        <div class="modal-content">
            <h2>Select Theme</h2>
            <div class="theme-grid" id="theme-grid"></div>
            <button onclick="closeModals()" style="width:100%; margin-top:10px;">Close (Esc)</button>
        </div>
    </div>

    <div id="modal-stats" class="modal">
        <div class="modal-content">
            <h2>Network Stats</h2>
            <pre id="stats-output"></pre>
            <button onclick="closeModals()" style="width:100%; margin-top:10px;">Close (Esc)</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="sidebar">
        <div class="brand">
            <span>M4</span><span>messenger</span>
        </div>
        <div class="lists" id="sidebar-lists">
            <div class="section-title">Rooms</div>
            <div id="room-list"></div>
            <div class="section-title">Peers</div>
            <div id="user-list"></div>
        </div>
        <div class="cmd-area">
            <div id="cmd-feedback"></div>
            <input type="text" id="cmd-input" placeholder="Type command..." autocomplete="off">
        </div>
    </div>

    <div id="main">
        <div id="chat-header">
            <button id="menu-toggle" onclick="toggleSidebar()">☰</button>
            <span id="chat-title">General</span>
            <span id="connection-status" style="font-size:0.8em; color: var(--accent);">●</span>
        </div>
        <div id="messages">
            <div class="msg">
                <span class="msg-meta">System</span>
                Welcome to M4messenger. Decentralized. No Auth. Square.
            </div>
        </div>
        <div id="input-area">
            <textarea id="msg-input" placeholder="Message... (Enter to send)"></textarea>
            <button id="send-btn">RUN</button>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://peer.wall.org/gun', 'https://gundb.herokuapp.com/gun']);
        const user = gun.user();
        const state = {
            currentRoom: 'general',
            username: 'Guest-' + Math.random().toString(36).substr(2, 4),
            theme: localStorage.getItem('m4_theme') || 'dark',
            radius: localStorage.getItem('m4_radius') === 'true',
            snow: localStorage.getItem('m4_snow') === 'true',
            lang: localStorage.getItem('m4_lang') || 'eng'
        };

        // --- DOM ELEMENTS ---
        const els = {
            input: document.getElementById('msg-input'),
            msgs: document.getElementById('messages'),
            cmd: document.getElementById('cmd-input'),
            feedback: document.getElementById('cmd-feedback'),
            rooms: document.getElementById('room-list'),
            users: document.getElementById('user-list'),
            title: document.getElementById('chat-title'),
            snow: document.getElementById('snow-canvas')
        };

        // --- INIT ---
        window.onload = () => {
            applyTheme(state.theme);
            applyRadius(state.radius);
            if(state.snow) toggleSnow(true);
            renderRooms();
            joinRoom('general');
            
            // Generate Random User if not exists
            if(!localStorage.getItem('m4_alias')) {
                localStorage.setItem('m4_alias', state.username);
            } else {
                state.username = localStorage.getItem('m4_alias');
            }
            
            // Announce presence
            gun.get('m4_peers').get(state.username).put(new Date().getTime());
            setInterval(() => gun.get('m4_peers').get(state.username).put(new Date().getTime()), 5000);
        };

        // --- KEYBOARD & A11Y LOGIC ---
        document.addEventListener('keydown', (e) => {
            // Global Shortcuts
            if (e.altKey && e.key === 'c') { e.preventDefault(); els.input.focus(); }
            if (e.altKey && e.key === 'm') { e.preventDefault(); els.cmd.focus(); }
            if (e.altKey && e.key === 'r') { e.preventDefault(); els.rooms.querySelector('.list-item')?.focus(); }
            if (e.key === 'Escape') closeModals();
        });

        els.input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        els.cmd.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                processCommand(els.cmd.value);
                els.cmd.value = '';
            }
        });

        // --- CORE FUNCTIONS ---
        function sendMessage() {
            const txt = els.input.value.trim();
            if(!txt) return;
            const msg = {
                text: txt,
                user: state.username,
                ts: Date.now()
            };
            gun.get('m4_rooms').get(state.currentRoom).set(msg);
            els.input.value = '';
        }

        function joinRoom(roomName) {
            state.currentRoom = roomName;
            els.title.innerText = '#' + roomName;
            els.msgs.innerHTML = ''; // Clear view
            
            // Subscribe to room
            gun.get('m4_rooms').get(roomName).map().once((data, id) => {
                if(!data) return;
                renderMessage(data);
            });

            // Mobile Drawer Logic
            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
        }

        function renderMessage(data) {
            const div = document.createElement('div');
            div.className = `msg ${data.user === state.username ? 'me' : ''}`;
            div.innerHTML = `<span class="msg-meta">${data.user}</span>${data.text}`;
            els.msgs.appendChild(div);
            els.msgs.scrollTop = els.msgs.scrollHeight;
        }

        // --- SIDEBAR LISTS (With Keyboard Support) ---
        const defaultRooms = ['general', 'random', 'tech', 'crypto'];
        function renderRooms() {
            els.rooms.innerHTML = '';
            defaultRooms.forEach(r => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerText = '#' + r;
                div.tabIndex = 0; // A11Y
                div.onclick = () => joinRoom(r);
                div.onkeydown = (e) => { if(e.key === 'Enter') joinRoom(r); };
                els.rooms.appendChild(div);
            });
        }

        // Listen for peers
        gun.get('m4_peers').map().on((ts, name) => {
            if(Date.now() - ts > 10000) return; // Ignore old
            if(document.getElementById('u-'+name)) return;
            
            const div = document.createElement('div');
            div.id = 'u-'+name;
            div.className = 'list-item';
            div.innerText = '@' + name;
            div.tabIndex = 0; // A11Y
            div.onclick = () => { /* Direct Msg Logic Placeholder */ };
            els.users.appendChild(div);
        });

        // --- COMMAND SYSTEM ---
        function processCommand(str) {
            const [cmd, ...args] = str.trim().split(' ');
            let feedback = 'Done.';
            
            switch(cmd.toLowerCase()) {
                case 'clean':
                    localStorage.clear();
                    sessionStorage.clear();
                    location.reload();
                    break;
                case 'soft':
                    state.radius = !state.radius;
                    localStorage.setItem('m4_radius', state.radius);
                    applyRadius(state.radius);
                    feedback = `Radius: ${state.radius ? '18px' : '0px'}`;
                    break;
                case 'snow':
                    state.snow = !state.snow;
                    localStorage.setItem('m4_snow', state.snow);
                    toggleSnow(state.snow);
                    feedback = `Snow: ${state.snow ? 'ON' : 'OFF'}`;
                    break;
                case 'theme':
                    openModal('theme');
                    renderThemePicker();
                    feedback = 'Opened Theme Picker';
                    break;
                case 'help':
                    openModal('help');
                    feedback = 'Opened Help';
                    break;
                case 'stats':
                    openModal('stats');
                    document.getElementById('stats-output').innerText = JSON.stringify(gun._.opt.peers, null, 2);
                    feedback = 'Opened Stats';
                    break;
                case 'nick':
                    if(args[0] && args[0].startsWith('@')) {
                        // Alias logic here
                        feedback = `Alias set for ${args[0]}`;
                    } else { feedback = 'Usage: nick @user Name'; }
                    break;
                default:
                    feedback = 'Unknown command. Try help.';
            }
            els.feedback.innerText = feedback;
            setTimeout(() => els.feedback.innerText = '', 3000);
        }

        // --- THEME ENGINE ---
        function applyTheme(name) {
            document.documentElement.setAttribute('data-theme', name);
            localStorage.setItem('m4_theme', name);
            state.theme = name;
        }

        function applyRadius(isSoft) {
            document.documentElement.style.setProperty('--radius', isSoft ? '18px' : '0px');
        }

        function renderThemePicker() {
            const grid = document.getElementById('theme-grid');
            grid.innerHTML = '';
            const themes = ['light', 'dark', 'blue', 'purple', 'crimson', 'emerald', 'midnight', 'coffee', 'solarized', 'amber'];
            themes.forEach(t => {
                const btn = document.createElement('div');
                btn.className = 'theme-btn';
                btn.innerText = t.toUpperCase();
                btn.tabIndex = 0; // A11Y
                btn.onclick = () => applyTheme(t);
                btn.onkeydown = (e) => { if(e.key === 'Enter') applyTheme(t); };
                btn.setAttribute('data-theme', t); // Preview style
                // Inline styles for preview
                if(t==='light') btn.style.background='#fff';
                if(t==='dark') btn.style.background='#000';
                // ... (simplified preview)
                grid.appendChild(btn);
            });
        }

        // --- UI UTILS ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }
        function openModal(id) {
            closeModals();
            document.getElementById('modal-'+id).style.display = 'flex';
            document.getElementById('modal-'+id).querySelector('button, .theme-btn')?.focus();
        }
        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            els.cmd.focus();
        }

        // --- SNOW EFFECT (Simplified for Performance) ---
        let snowInterval;
        function toggleSnow(enable) {
            const canvas = els.snow;
            if(!enable) {
                canvas.style.display = 'none';
                clearInterval(snowInterval);
                return;
            }
            canvas.style.display = 'block';
            const ctx = canvas.getContext('2d');
            const W = window.innerWidth, H = window.innerHeight;
            canvas.width = W; canvas.height = H;
            const mp = 50; 
            const particles = [];
            for(let i=0; i<mp; i++) particles.push({x: Math.random()*W, y: Math.random()*H, r: Math.random()*2+1, d: Math.random()*mp});
            
            function draw() {
                ctx.clearRect(0, 0, W, H);
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                ctx.beginPath();
                for(let i=0; i<mp; i++) {
                    const p = particles[i];
                    ctx.moveTo(p.x, p.y);
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2, true);
                }
                ctx.fill();
                update();
            }
            let angle = 0;
            function update() {
                angle += 0.01;
                for(let i=0; i<mp; i++) {
                    const p = particles[i];
                    p.y += Math.cos(angle+p.d) + 1 + p.r/2;
                    p.x += Math.sin(angle) * 2;
                    if(p.x > W+5 || p.x < -5 || p.y > H) {
                        particles[i] = {x: Math.random()*W, y: -10, r: p.r, d: p.d};
                    }
                }
            }
            snowInterval = setInterval(draw, 33);
        }
    </script>
</body>
</html>