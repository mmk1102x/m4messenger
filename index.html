<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>M4messenger</title>
    <link rel="icon" id="dynamic-favicon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20rx%3D%2220%22%20fill%3D%22%23007aff%22%2F%3E%3Ctext%20y%3D%22.9em%22%20font-size%3D%2270%22%20fill%3D%22%23fff%22%20font-family%3D%22monospace%22%20font-weight%3D%22bold%22%20x%3D%2215%22%3EM4%3C%2Ftext%3E%3C%2Fsvg%3E">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/webrtc.js"></script>
    <style>
        :root { 
            --bg: #ffffff; --panel: #f2f2f7; --border: #d1d1d6; --text: #000; --text-dim: #8e8e93; 
            --hl: #007aff; --hl-border: #007aff; --warn: #ff3b30; --input-bg: #fff; 
            --msg-mine: #007aff; --msg-other: #e9e9eb; --mention: #ff9500;
            --radius: 0px; --border-style: solid;
        }
        [data-theme="dark"] { --bg: #000; --panel: #1c1c1e; --border: #333; --text: #0f0; --text-dim: #050; --hl: #0f0; --hl-border: #0f0; --warn: #f00; --input-bg: #000; --msg-mine: #050; --msg-other: #111; --mention: #f80; }
        [data-theme="coffee"] { --bg: #fdf6e3; --panel: #eee8d5; --border: #d3af86; --text: #5d4037; --text-dim: #a1887f; --hl: #8d6e63; --hl-border: #8d6e63; --warn: #c62828; --input-bg: #fdf6e3; --msg-mine: #8d6e63; --msg-other: #efebe9; --mention: #bf360c; }
        [data-theme="coffee-dark"] { --bg: #2b2118; --panel: #1f1610; --border: #3e2f24; --text: #dcc8b8; --text-dim: #8d6e63; --hl: #a67c52; --hl-border: #a67c52; --warn: #c62828; --input-bg: #1f1610; --msg-mine: #543d2e; --msg-other: #3e2f24; --mention: #ffccbc; }
        [data-theme="emerald"] { --bg: #06100c; --panel: #0a1a14; --border: #143a2b; --text: #2ecc71; --text-dim: #1d6e41; --hl: #2ecc71; --hl-border: #2ecc71; --warn: #ff4d4d; --input-bg: #06100c; --msg-mine: #1d6e41; --msg-other: #122b21; --mention: #fff; }
        [data-theme="midnight"] { --bg: #00040a; --panel: #000814; --border: #002244; --text: #5080ff; --text-dim: #004488; --hl: #5080ff; --hl-border: #5080ff; --warn: #ff453a; --input-bg: #00040a; --msg-mine: #004488; --msg-other: #001122; --mention: #fff; }
        [data-theme="amber"] { --bg: #0d0b00; --panel: #141100; --border: #443300; --text: #ffbf00; --text-dim: #886600; --hl: #ffbf00; --hl-border: #ffbf00; --warn: #ff4d4d; --input-bg: #0d0b00; --msg-mine: #443300; --msg-other: #1a1600; --mention: #fff; }
        [data-theme="solarized"] { --bg: #002b36; --panel: #073642; --border: #586e75; --text: #839496; --text-dim: #586e75; --hl: #268bd2; --hl-border: #268bd2; --warn: #dc322f; --input-bg: #002b36; --msg-mine: #073642; --msg-other: #001e26; --mention: #b58900; }
        [data-theme="blue"] { --bg: #001f3f; --panel: #001a33; --border: #003366; --text: #00e5ff; --text-dim: #007acc; --hl: #00e5ff; --hl-border: #003366; --warn: #ff4136; --input-bg: #001226; --msg-mine: #003366; --msg-other: #001a33; --mention: #fff; }
        [data-theme="purple"] { --bg: #0f0a1e; --panel: #1a1233; --border: #2d1e5e; --text: #bf5af2; --text-dim: #5e2d91; --hl: #bf5af2; --hl-border: #2d1e5e; --warn: #ff375f; --input-bg: #0f0a1e; --msg-mine: #5e2d91; --msg-other: #1c1c1e; --mention: #00ffff; }
        [data-theme="crimson"] { --bg: #1a0505; --panel: #280a0a; --border: #441111; --text: #ff4d4d; --text-dim: #882222; --hl: #ff4d4d; --hl-border: #441111; --warn: #ffcc00; --input-bg: #0d0101; --msg-mine: #661111; --msg-other: #110303; --mention: #ffffff; }

        * { box-sizing: border-box; outline: none; border-radius: var(--radius); }
        body { font-family: monospace; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100dvh; width: 100vw; overflow: hidden; transition: 0.3s; position: relative; }
        *:focus-visible { outline: 2px solid var(--hl); outline-offset: -2px; z-index: 10; }

        #sidebar { width: 300px; min-width: 300px; background: var(--panel); border-right: 2px var(--border-style) var(--border); display: flex; flex-direction: column; padding: 20px; z-index: 1000; height: 100dvh; transition: transform 0.3s; }
        #logo-container { display: flex; align-items: center; justify-content: flex-start; gap: 12px; margin-bottom: 25px; }
        #logo-icon { width: 45px; height: 45px; background: var(--hl) !important; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5em; flex-shrink: 0; transition: background 0.3s; }
        #logo-text { font-weight: 900; font-size: 1.3em; letter-spacing: -1px; }
        
        #identity { text-align: center; margin-bottom: 25px; border-bottom: 1px var(--border-style) var(--border); padding-bottom: 15px; }
        #my-name-display { font-weight: 900; font-size: 1.2em; cursor: pointer; padding: 5px; }
        #my-handle-display { font-size: 0.85em; opacity: 0.6; cursor: pointer; padding: 5px; }
        #my-name-display:hover, #my-handle-display:hover { background: var(--bg); outline: 1px solid var(--hl); }

        #main { flex-grow: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; height: 100%; overflow: hidden; }
        #header { height: 60px; background: var(--panel); border-bottom: 2px var(--border-style) var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        #header-left { display: flex; align-items: center; }
        #hamburger { display: none; cursor: pointer; font-size: 1.5em; margin-right: 15px; }
        
        #net-status { width: 12px; height: 12px; border-radius: 50%; background: #ff9500; box-shadow: 0 0 5px #ff9500; transition: 0.3s; margin-left: 10px; cursor: pointer; }
        #net-status.connected { background: var(--hl) !important; box-shadow: 0 0 8px var(--hl) !important; }
        
        #net-console { background: #000; color: #0f0; font-family: monospace; padding: 10px; height: 150px; overflow-y: auto; font-size: 0.7em; margin-bottom: 10px; border-radius: 4px; border: 1px solid #333; }

        .section-title { color: var(--text-dim); font-size: 0.75em; margin: 15px 0 8px 0; font-weight: 800; text-transform: uppercase; }
        .scroll-list { overflow-y: auto; flex: 1; border: 2px var(--border-style) var(--border); background: var(--input-bg); margin-bottom: 10px; }
        .list-item { padding: 12px; cursor: pointer; border-bottom: 1px var(--border-style) var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; transition: 0.2s; }
        .list-item:hover, .list-item:focus { background: var(--msg-other); }
        .active-chan { background: var(--hl) !important; color: #fff !important; font-weight: 800; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; border: 1px solid var(--text-dim); margin-left: 8px; }
        .online { background: var(--hl); border-color: var(--hl); }
        
        .btn, input, #send-btn, #btn-run { border-radius: var(--radius) !important; transition: 0.2s; border: 2px var(--border-style) var(--border); font-family: inherit; }
        .btn { background: var(--panel); color: var(--text); padding: 10px; cursor: pointer; width: 100%; font-weight: bold; }
        .btn:focus { border-color: var(--hl); }
        
        #chat { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 16px; max-width: 80%; line-height: 1.4em; word-wrap: break-word; border: 2px var(--border-style) var(--border); position: relative; }
        .msg-mine { align-self: flex-end; background: var(--msg-mine); color: #fff; }
        .msg-other { align-self: flex-start; background: var(--msg-other); }
        
        #controls-form { padding: 15px; background: var(--panel); border-top: 2px var(--border-style) var(--border); display: flex; gap: 10px; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        #message { flex-grow: 1; background: var(--input-bg); color: var(--text); padding: 12px; font-size: 16px; }
        #send-btn { background: var(--hl-border); color: #fff; padding: 0 25px; font-weight: 900; cursor: pointer; border: none !important; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh; background: rgba(0,0,0,0.7); z-index: 99999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--bg); border: 4px var(--border-style) var(--hl-border); padding: 30px; width: 450px; max-width: 90%; color: var(--text); box-shadow: 0 20px 60px rgba(0,0,0,0.4); }

        @media (max-width: 768px) {
            #sidebar { position: fixed; transform: translateX(-100%); width: 280px; }
            #sidebar.open { transform: translateX(0); }
            #hamburger { display: block; }
        }
    </style>
</head>
<body data-theme="light">
    
    <div id="sidebar">
        <div id="logo-container">
            <div id="logo-icon">M4</div>
            <div id="logo-text">messenger</div>
        </div>
        
        <div id="identity">
            <div id="my-name-display" tabindex="0" onclick="startRenaming('name')" onkeydown="if(event.key==='Enter') startRenaming('name')">Guest</div>
            <div id="my-handle-display" tabindex="0" onclick="startRenaming('handle')" onkeydown="if(event.key==='Enter') startRenaming('handle')">@handle</div>
        </div>

        <div class="section-title"><span id="lbl-rooms">ROOMS</span> <span onclick="openModal('create-room')" style="cursor:pointer; color:var(--hl); float:right;">[+]</span></div>
        <div id="room-list" class="scroll-list"></div>
        <div class="section-title" id="lbl-users">USERS</div>
        <div id="user-list" class="scroll-list"></div>
        
        <div id="bottom-panel" style="margin-top: auto;">
            <form onsubmit="event.preventDefault(); runCode();" style="display:flex; gap:5px;">
                <input type="search" id="code-in" placeholder="Command..." autocomplete="off" style="flex-grow:1; background:var(--input-bg); border:2px var(--border-style) var(--border); color:var(--text); padding:10px; font-size:14px;">
                <button type="submit" id="btn-run" style="background:var(--hl); color:#fff; width: 70px; cursor:pointer; font-weight:900;">RUN</button>
            </form>
            <div id="cmd-feedback" style="font-size: 0.7em; color: var(--hl); text-align: center; margin-top:5px; height:1em; font-weight:bold;"></div>
        </div>
    </div>

    <div id="main">
        <div id="header">
            <div id="header-left">
                <div id="hamburger" onclick="toggleSidebar()">â˜°</div>
                <div id="header-text">#GENERAL</div>
            </div>
            <div id="net-status" title="Status (Click for Logs)" onclick="openModal('network')"></div>
        </div>
        <div id="chat"></div>
        <form id="controls-form" onsubmit="event.preventDefault(); send();">
            <input type="search" id="message" placeholder="Message..." autocomplete="off">
            <button id="send-btn" type="submit">SEND</button>
        </form>
    </div>

    <!-- MODALS -->
    <div id="modal-network" class="modal">
        <div class="modal-box">
            <h3>NETWORK</h3>
            <div id="net-console"></div>
            <div style="font-size:0.8em; margin:10px 0;"><strong>Connect via IP/URL:</strong></div>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <input id="new-peer-url" placeholder="wss://... or IP:PORT" style="flex:1;">
                <button class="btn" style="width:auto;" onclick="addPeer()">CONNECT</button>
            </div>
            <hr style="border:0; border-top:1px solid var(--border); margin:10px 0;">
            <div style="font-size:0.8em; margin-bottom:5px;"><strong>Share Connection (QR/Hash):</strong></div>
            <div style="display:flex; justify-content:center; margin:10px 0; background:#fff; padding:10px; border-radius:4px;">
                <canvas id="qr-code" style="width:150px; height:150px;"></canvas>
            </div>
            <div style="text-align:center;">
                <button class="btn" style="font-size:0.8em; padding:5px 10px;" onclick="copyHashLink()">COPY HASH LINK</button>
                <div id="share-feedback" style="font-size:0.7em; margin-top:5px; height:1.2em;"></div>
            </div>
            <button class="btn" style="margin-top:15px;" onclick="closeModals()">CLOSE</button>
        </div>
    </div>

    <div id="modal-create-room" class="modal"><div class="modal-box"><h3>NEW ROOM</h3><input id="new-room-name" placeholder="Name"><button class="btn" onclick="createRoom()" style="margin-top:10px;">CREATE</button><button class="btn" style="margin-top:5px;border:none;background:none;color:var(--text-dim);" onclick="closeModals()">CANCEL</button></div></div>
    
    <div id="modal-help" class="modal">
        <div class="modal-box">
            <h3>HELP</h3>
            <div id="help-list" style="white-space:pre-line;font-size:0.85em;line-height:1.6em;margin-bottom:15px;"></div>
            <button class="btn" onclick="closeModals()">CLOSE</button>
        </div>
    </div>
    
    <div id="modal-themes" class="modal">
        <div class="modal-box">
            <h3>THEMES</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; max-height: 50vh; overflow-y:auto;" id="theme-grid"></div>
            <button class="btn" style="margin-top:15px;" onclick="closeModals()">CLOSE</button>
        </div>
    </div>

    <link rel="icon" id="dynamic-favicon" href="">

    <script>
        // --- UTILS ---
        function normalizePeerUrl(url) {
            url = url.trim();
            if(!url) return '';
            if(!url.startsWith('http') && !url.startsWith('ws')) url = 'https://' + url;
            if(!url.endsWith('/gun')) url = url.replace(/\/$/, '') + '/gun';
            return url;
        }

        // --- INIT & PEERS ---
        const urlParams = new URLSearchParams(window.location.search);
        const hashConnect = location.hash.startsWith('#c=') ? atob(location.hash.split('#c=')[1]) : null;
        const urlRelay = urlParams.get('relay') || urlParams.get('connect') || hashConnect;
        
        let savedPeers = JSON.parse(localStorage.getItem('m4_custom_peers') || '[]');
        if (urlRelay) {
            const cleanUrl = normalizePeerUrl(urlRelay);
            if (!savedPeers.includes(cleanUrl)) {
                savedPeers.push(cleanUrl);
                localStorage.setItem('m4_custom_peers', JSON.stringify(savedPeers));
                alert("New Relay Added: " + cleanUrl);
            }
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        function log(msg) {
            const c = document.getElementById('net-console');
            if(c) { c.innerHTML += `<div>> ${msg}</div>`; c.scrollTop = c.scrollHeight; }
            console.log(msg);
        }

        const peers = [
            'https://m4-backend.onrender.com/gun',
            'https://relay.peer.ooo/gun',
            'https://gun-manhattan.herokuapp.com/gun',
            'https://gun-us.herokuapp.com/gun',
            'https://plato.design/gun'
        ];
        const allPeers = [...peers, ...savedPeers];
        log(`Init Gun with ${allPeers.length} peers...`);

        const gun = Gun({ peers: allPeers, localStorage: true, radisk: true });

        // --- NETWORK UI ---
        const statusEl = document.getElementById('net-status');
        gun.on('hi', (peer) => {
            statusEl.classList.add('connected');
            statusEl.title = `Connected: ${peer.url}`;
            log(`CONNECTED: ${peer.url || 'Peer'}`);
            if(peer.url) updateQR(peer.url);
        });
        gun.on('bye', (peer) => { log(`DISCONNECTED: ${peer.url}`); });

        function updateQR(url) {
            new QRious({ element: document.getElementById('qr-code'), value: window.location.origin + window.location.pathname + '#c=' + btoa(url), size: 150 });
        }
        function copyHashLink() {
            const activeUrl = savedPeers.length > 0 ? savedPeers[savedPeers.length-1] : peers[0];
            const fullLink = window.location.origin + window.location.pathname + '#c=' + btoa(activeUrl);
            navigator.clipboard.writeText(fullLink).then(() => {
                document.getElementById('share-feedback').innerText = "Link Copied!";
                setTimeout(() => document.getElementById('share-feedback').innerText = "", 2000);
            });
        }
        function addPeer() {
            let url = document.getElementById('new-peer-url').value;
            url = normalizePeerUrl(url);
            if(url) {
                savedPeers.push(url);
                localStorage.setItem('m4_custom_peers', JSON.stringify(savedPeers));
                gun.opt({ peers: [url] });
                log(`Added: ${url}`);
                updateQR(url);
                document.getElementById('new-peer-url').value = '';
            }
        }

        // --- STATE ---
        let myHandle = localStorage.getItem('m4_handle') || Math.random().toString(36).substring(2, 10);
        let myName = localStorage.getItem('m4_name') || "Guest";
        localStorage.setItem('m4_handle', myHandle);
        let currentTarget = "#GENERAL";
        
        // --- SYNC ENGINE (FIXED) ---
        const bc = new BroadcastChannel('m4_v24_sync');
        bc.onmessage = (ev) => {
            if(ev.data && ev.data.type === 'msg' && ev.data.room === currentTarget) {
                if(!document.getElementById('msg-' + (ev.data.data.localId || ev.data.data.time))) drawMessage(ev.data.data);
            }
        };

        function send() {
            const i = document.getElementById('message'); if(!i.value) return;
            const lId = Date.now();
            const d = { from: myName, handle: myHandle, msg: i.value, time: lId, channel: currentTarget, localId: lId };
            
            drawMessage(d, true); // Optimistic
            bc.postMessage({type:'msg', room: currentTarget, data: d}); // Local
            gun.get('m4_mesh_v24').get(currentTarget).set(d); // Network
            i.value = "";
        }

        function syncRoom(roomName) {
            document.getElementById('chat').innerHTML = ""; // Clear Chat
            
            // STRICT CHANNEL FILTERING:
            // 1. Use .map().on() for realtime updates
            // 2. Filter incoming data by channel name to prevent cross-talk
            gun.get('m4_mesh_v24').get(roomName).map().on((d) => {
                if(!d || d.channel !== roomName) return; // THE FIX
                if(document.getElementById('msg-' + (d.localId || d.time))) return;
                drawMessage(d);
            });
        }

        function drawMessage(d, isP=false) {
            // Extra safety check in drawing
            if(d.channel !== currentTarget) return;

            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            const isMe = d.handle === myHandle;
            div.id = 'msg-' + (d.localId || d.time);
            div.className = 'msg ' + (isMe ? 'msg-mine' : 'msg-other');
            let content = (!isMe) ? `<span style="font-size:0.75em;display:block;opacity:0.6;margin-bottom:4px;font-weight:900;">${d.from} (@${d.handle})</span>` : "";
            div.innerHTML = content + d.msg.replace(new RegExp(`@${myHandle}\\b`, 'gi'), `<span class="mention">@${myHandle}</span>`);
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function switchChannel(t) { 
            currentTarget = t; 
            document.getElementById('header-text').innerText = t; 
            
            // Fix Highlighting
            document.querySelectorAll('.list-item').forEach(el => el.classList.remove('active-chan'));
            
            // Try ID (Rooms)
            const roomEl = document.getElementById('room-' + t.replace('#',''));
            if(roomEl) roomEl.classList.add('active-chan');
            else {
                // Try ID (User)
                const userEl = document.getElementById('peer-' + t);
                if(userEl) userEl.classList.add('active-chan');
            }

            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
            syncRoom(t);
        }

        // --- PRESENCE ---
        function announcePresence() { gun.get('m4_users_v24').get(myHandle).put({name: myName, lastSeen: Date.now()}); }
        announcePresence(); setInterval(announcePresence, 10000);

        gun.get('m4_users_v24').map().on((user, handle) => {
            if(!user || !user.name) return;
            renderPeer(user, handle);
        });

        function renderPeer(user, handle) {
            const list = document.getElementById('user-list');
            let el = document.getElementById('peer-' + handle);
            if(!el) {
                el = document.createElement('div'); el.id = 'peer-' + handle; el.className = 'list-item';
                el.tabIndex = 0;
                el.onclick = () => switchChannel(handle); // DM support
                el.onkeydown = (e) => { if(e.key === 'Enter') switchChannel(handle); };
                list.appendChild(el);
            }
            const isOnline = (Date.now() - (user.lastSeen || 0)) < 60000;
            el.innerHTML = `<span>${user.name} (@${handle})</span><span class="status-dot ${isOnline?'online':''}"></span>`;
            el.style.opacity = isOnline ? '1' : '0.6';
        }

        // --- ROOMS ---
        let customRooms = JSON.parse(localStorage.getItem('m4_rooms') || '["GENERAL","TECH","RANDOM"]');
        function renderRooms() {
            const list = document.getElementById('room-list');
            list.innerHTML = "";
            customRooms.forEach(r => {
                const d = document.createElement('div');
                d.id = 'room-' + r; 
                d.className = 'list-item'; d.innerText = '#'+r; d.tabIndex = 0;
                if(r === currentTarget.replace('#','')) d.classList.add('active-chan');
                d.onclick = () => switchChannel('#'+r);
                d.onkeydown = (e) => { if(e.key==='Enter') switchChannel('#'+r); };
                list.appendChild(d);
            });
        }
        function createRoom() {
            const r = document.getElementById('new-room-name').value.trim().toUpperCase().replace(/#/g,'');
            if(r && !customRooms.includes(r)) {
                customRooms.push(r);
                localStorage.setItem('m4_rooms', JSON.stringify(customRooms));
                renderRooms();
                switchChannel('#'+r);
            }
            closeModals();
        }

        // --- UI & HOTKEYS ---
        document.addEventListener('keydown', (e) => {
            if (e.altKey && e.key === 'c') { e.preventDefault(); document.getElementById('message').focus(); }
            if (e.altKey && e.key === 'm') { e.preventDefault(); document.getElementById('code-in').focus(); }
            if (e.key === 'Escape') closeModals();
        });
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function closeModals() { document.querySelectorAll('.modal').forEach(e => e.style.display='none'); document.getElementById('code-in').focus(); }
        function openModal(id) { 
            closeModals(); document.getElementById('modal-'+id).style.display = 'flex'; 
            if(id==='network') updateQR(savedPeers.length>0?savedPeers[savedPeers.length-1]:peers[0]);
        }
        function startRenaming(type) { 
            const el = document.getElementById(type === 'name' ? 'my-name-display' : 'my-handle-display');
            if(el.querySelector('input')) return;
            const val = type === 'name' ? myName : myHandle;
            el.innerHTML = `<input id="ren-in" value="${val}" style="width:80%; font-size:1em; padding:2px;" onblur="finishRename('${type}')" onkeypress="if(event.key==='Enter') finishRename('${type}')">`;
            setTimeout(() => document.getElementById('ren-in').focus(), 50);
        }
        function finishRename(type) {
            const i = document.getElementById('ren-in'); if(!i) return;
            let n = i.value.trim().replace(/\s/g, ''); if(!n) n = (type==='name'?'Guest':'user');
            if(type === 'name') { myName = n; localStorage.setItem('m4_name', n); }
            else { myHandle = n; localStorage.setItem('m4_handle', n); }
            document.getElementById('my-name-display').innerText = myName;
            document.getElementById('my-handle-display').innerText = '@' + myHandle;
            announcePresence();
        }

        // --- COMMANDS ---
        function runCode(manual = null) {
            const i = document.getElementById('code-in'); const raw = (manual || i.value).trim(); const c = raw.toLowerCase();
            const themes = ['light','dark','blue','purple','crimson','emerald','midnight','coffee','coffee-dark','solarized','amber'];
            if(themes.includes(c)) { 
                document.body.setAttribute('data-theme', c); localStorage.setItem('m4_theme', c); updateFavicon(c); 
            }
            else if(c.startsWith('connect ')) {
                let url = c.split(' ')[1]; if(url) { savedPeers.push(normalizePeerUrl(url)); localStorage.setItem('m4_custom_peers', JSON.stringify(savedPeers)); gun.opt({ peers: [normalizePeerUrl(url)] }); }
            }
            else if(c === 'relay list') openModal('network');
            else if(c === 'clean') { localStorage.clear(); location.reload(); }
            else if(c === 'help') { document.getElementById('help-list').innerText = "Commands: theme [name], connect [url], clean, help"; openModal('help'); }
            else if(c === 'theme') {
                const g = document.getElementById('theme-grid'); g.innerHTML='';
                themes.forEach(t => { 
                    const b = document.createElement('button'); b.className='btn'; b.innerText=t.toUpperCase(); 
                    b.onclick=()=>runCode(t); g.appendChild(b); 
                });
                openModal('themes');
            }
            document.getElementById('cmd-feedback').innerText = "OK"; setTimeout(()=>document.getElementById('cmd-feedback').innerText="", 2000); i.value = "";
        }

        // --- STARTUP ---
        const savedTheme = localStorage.getItem('m4_theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        updateFavicon(savedTheme); 
        document.getElementById('my-name-display').innerText = myName;
        document.getElementById('my-handle-display').innerText = '@' + myHandle;
        
        renderRooms();
        syncRoom('GENERAL');
    </script>
</body>
</html>
